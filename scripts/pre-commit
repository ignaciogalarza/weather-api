#!/bin/bash
# Pre-commit hook: Runs linting, type checking, and tests before allowing commit
# Skip with: git commit --no-verify

set -e

# Source uv environment
if [ -f "$HOME/.local/bin/env" ]; then
    . "$HOME/.local/bin/env"
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"
echo ""

# Navigate to repository root
cd "$(git rev-parse --show-toplevel)"

# Check if uv is available
if ! command -v uv &> /dev/null; then
    echo -e "${RED}Error: uv is not installed or not in PATH${NC}"
    exit 1
fi

# Step 1: Lint with Ruff
echo -e "${YELLOW}[1/3] Running Ruff linter...${NC}"
if uv run ruff check src tests; then
    echo -e "${GREEN}✓ Linting passed${NC}"
else
    echo -e "${RED}✗ Linting failed${NC}"
    echo -e "${YELLOW}Tip: Run 'uv run ruff check --fix src tests' to auto-fix issues${NC}"
    exit 1
fi
echo ""

# Step 2: Type check with MyPy
echo -e "${YELLOW}[2/3] Running MyPy type checker...${NC}"
if uv run mypy; then
    echo -e "${GREEN}✓ Type checking passed${NC}"
else
    echo -e "${RED}✗ Type checking failed${NC}"
    exit 1
fi
echo ""

# Step 3: Run tests with Pytest
echo -e "${YELLOW}[3/3] Running tests...${NC}"
if uv run pytest -q; then
    echo -e "${GREEN}✓ All tests passed${NC}"
else
    echo -e "${RED}✗ Tests failed${NC}"
    exit 1
fi
echo ""

echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
